---
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import fs from "fs";
import path from "path";

interface CityData {
    id: string;
    data: {
        title: string;
        country: string;
        date: string;
        rating: number;
        flag: string;
        favorite?: boolean;
    };
}

// Load cities from markdown files
const countriesDir = path.join(process.cwd(), "src/content/countries");
const files = fs
    .readdirSync(countriesDir)
    .filter((file) => file.endsWith(".md"));

const allCities: CityData[] = files
    .map((file) => {
        const filePath = path.join(countriesDir, file);
        const content = fs.readFileSync(filePath, "utf-8");
        const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);

        if (!frontmatterMatch) return null;

        const frontmatter = frontmatterMatch[1];
        const data: Record<string, any> = {};
        const frontmatterLines = frontmatter.split("\n");

        for (const line of frontmatterLines) {
            const [key, ...valueParts] = line.split(":");
            if (key && valueParts.length > 0) {
                const value = valueParts.join(":").trim();
                if (key === "rating") {
                    data[key] = parseInt(value);
                } else if (key === "favorite") {
                    data[key] = value === "true";
                } else {
                    data[key] = value.replace(/^["']|["']$/g, "");
                }
            }
        }

        return {
            id: file.replace(".md", ""),
            data,
        };
    })
    .filter(Boolean) as CityData[];

export function getStaticPaths() {
    const countriesDir = path.join(process.cwd(), "src/content/countries");
    const files = fs
        .readdirSync(countriesDir)
        .filter((file) => file.endsWith(".md"));

    const allCities: CityData[] = files
        .map((file) => {
            const filePath = path.join(countriesDir, file);
            const content = fs.readFileSync(filePath, "utf-8");
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);

            if (!frontmatterMatch) return null;

            const frontmatter = frontmatterMatch[1];
            const data: Record<string, any> = {};
            const frontmatterLines = frontmatter.split("\n");

            for (const line of frontmatterLines) {
                const [key, ...valueParts] = line.split(":");
                if (key && valueParts.length > 0) {
                    const value = valueParts.join(":").trim();
                    if (key === "rating") {
                        data[key] = parseInt(value);
                    } else if (key === "favorite") {
                        data[key] = value === "true";
                    } else {
                        data[key] = value.replace(/^["']|["']$/g, "");
                    }
                }
            }

            return {
                id: file.replace(".md", ""),
                data,
            };
        })
        .filter(Boolean) as CityData[];

    const uniqueCountries = [
        ...new Set(allCities.map((city) => city.data.country)),
    ];

    return uniqueCountries.map((countryName) => {
        const countryCities = allCities.filter(
            (city) => city.data.country === countryName,
        );
        const flag = countryCities[0]?.data.flag || "üåç";
        const slug = countryName.toLowerCase().replace(/\s+/g, "-");

        return {
            params: { country: slug },
            props: {
                countryName,
                flag,
                cities: countryCities.sort((a, b) =>
                    a.data.title.localeCompare(b.data.title, "ru"),
                ),
            },
        };
    });
}

interface Props {
    countryName: string;
    flag: string;
    cities: CityData[];
}

const { countryName, flag, cities } = Astro.props;

const totalCities = cities.length;
const favorites = cities.filter((c) => c.data.favorite);
---

<Layout
    title={`${countryName} ${flag}`}
    description={`–ì–æ—Ä–æ–¥–∞ ${countryName}, –∫–æ—Ç–æ—Ä—ã–µ —è –ø–æ—Å–µ—Ç–∏–ª`}
>
    <Container>
        <div class="country-section">
            <!-- Back link -->
            <a href="/world" class="back-link">‚Üê –ú–∏—Ä</a>

            <!-- Header -->
            <h1><span class="flag">{flag}</span> {countryName}</h1>

            <!-- Cities list -->
            <section>
                <h2>–ì–æ—Ä–æ–¥–∞</h2>
                <div class="city-grid">
                    {
                        cities.map((city, i) => (
                            <>
                                <a
                                    href={`/countries/${city.id}`}
                                    class="city-link"
                                >
                                    {city.data.title}
                                </a>
                                {i < cities.length - 1 && (
                                    <span class="sep"> ¬∑ </span>
                                )}
                            </>
                        ))
                    }
                </div>
            </section>

            <!-- Favorites -->
            {
                favorites.length > 0 && (
                    <section>
                        <h2>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h2>
                        <div class="city-grid">
                            {favorites.map((city, i) => (
                                <>
                                    <a
                                        href={`/countries/${city.id}`}
                                        class="city-link"
                                    >
                                        {city.data.title}
                                    </a>
                                    {i < favorites.length - 1 && (
                                        <span class="sep"> ¬∑ </span>
                                    )}
                                </>
                            ))}
                        </div>
                    </section>
                )
            }

            <!-- Stats -->
            <p class="stats">
                –í—Å–µ–≥–æ: {totalCities}
                {
                    totalCities === 1
                        ? "–≥–æ—Ä–æ–¥"
                        : totalCities < 5
                          ? "–≥–æ—Ä–æ–¥–∞"
                          : "–≥–æ—Ä–æ–¥–æ–≤"
                }
            </p>
        </div>
    </Container>
</Layout>

<style>
    .country-section {
        font-size: 16px;
        line-height: 1.6;
    }

    .back-link {
        display: inline-block;
        margin-bottom: 24px;
        color: #0060a0;
        text-decoration: none;
        border-bottom: 1px solid rgba(0, 96, 160, 0.2);
        transition:
            border-color 0.15s ease-out,
            color 0.15s ease-out;
    }

    .back-link:hover {
        color: #004070;
        border-bottom-color: rgba(0, 96, 160, 0.6);
    }

    :global(.dark) .back-link {
        color: #5cacee;
        border-bottom-color: rgba(92, 172, 238, 0.25);
    }

    :global(.dark) .back-link:hover {
        color: #7ec0ff;
        border-bottom-color: rgba(92, 172, 238, 0.6);
    }

    h1 {
        font-size: 32px;
        font-weight: 700;
        margin: 0 0 24px 0;
        color: #000;
    }

    :global(.dark) h1 {
        color: #fff;
    }

    .flag {
        margin-right: 8px;
    }

    h2 {
        font-size: 20px;
        font-weight: 600;
        margin: 32px 0 12px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        color: #000;
    }

    :global(.dark) h2 {
        border-bottom-color: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .city-grid {
        column-count: 3;
        column-gap: 40px;
        line-height: 1.8;
    }

    @media (max-width: 640px) {
        .city-grid {
            column-count: 2;
            column-gap: 24px;
        }
    }

    @media (max-width: 400px) {
        .city-grid {
            column-count: 1;
        }
    }

    .city-link {
        color: #0060a0;
        text-decoration: none;
        border-bottom: 1px solid rgba(0, 96, 160, 0.2);
        transition:
            border-color 0.15s ease-out,
            color 0.15s ease-out;
        white-space: nowrap;
    }

    .city-link:hover {
        color: #004070;
        border-bottom-color: rgba(0, 96, 160, 0.6);
    }

    :global(.dark) .city-link {
        color: #5cacee;
        border-bottom-color: rgba(92, 172, 238, 0.25);
    }

    :global(.dark) .city-link:hover {
        color: #7ec0ff;
        border-bottom-color: rgba(92, 172, 238, 0.6);
    }

    .sep {
        color: #999;
        user-select: none;
    }

    :global(.dark) .sep {
        color: #666;
    }

    .stats {
        margin-top: 32px;
        padding-top: 16px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        color: #666;
        font-size: 14px;
    }

    :global(.dark) .stats {
        border-top-color: rgba(255, 255, 255, 0.1);
        color: #888;
    }
</style>
